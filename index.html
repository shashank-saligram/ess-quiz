<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MCQ Test</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.timer { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
#quiz { margin-bottom: 20px; }
.correct { color: green; font-weight: bold; }
.wrong { color: red; font-weight: bold; }
.unanswered { color: orange; font-style: italic; }
.answer-block { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
button { margin-right: 8px; padding: 8px 12px; }
.controls { margin-top: 10px; }
</style>
</head>
<body>
<h1>MCQ Test</h1>
<div class="timer">Time Left: <span id="time">20:00</span></div>
<div id="quiz"></div>

<div class="controls">
  <button id="prev">Previous</button>
  <button id="next">Next</button>
  <button id="submitNow">Submit Now</button>
</div>

<div id="result"></div>

<script>
let allQuestions = [];
let quizData = [];
let currentQuestion = 0;
let userAnswers = {};
let timer = null;
let timeLeft = 0;

function startTimer() {
  clearInterval(timer);
  timeLeft = 20 * 60;
  document.getElementById('time').textContent = formatTime(timeLeft);
  timer = setInterval(() => {
    timeLeft--;
    document.getElementById('time').textContent = formatTime(timeLeft);
    if (timeLeft <= 0) {
      clearInterval(timer);
      submitQuiz();
    }
  }, 1000);
}

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${s < 10 ? '0' : ''}${s}`;
}

function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function prepareQuiz() {
  userAnswers = {};
  currentQuestion = 0;
  quizData = shuffleArray(allQuestions).slice(0,40).map(q=>{
    return { question: q.Question, options: shuffleArray([q.Option1,q.Option2,q.Option3,q.Option4]), answerText: q.Answer || q.Option1 };
  });
}

function loadQuestion() {
  if(currentQuestion>=quizData.length){submitQuiz();return;}
  const q = quizData[currentQuestion];
  let html = `<h2>Question ${currentQuestion+1} of ${quizData.length}</h2>`;
  html += `<p>${q.question}</p><div class="options">`;
  for(let i=0;i<q.options.length;i++){
    const opt = q.options[i];
    const checked = userAnswers[currentQuestion]===opt?'checked':'';
    html += `<label><input type="radio" name="answer" value="${i}" ${checked}> ${opt}</label><br>`;
  }
  html += '</div>';
  document.getElementById('quiz').innerHTML = html;
  document.getElementById('prev').style.display = currentQuestion===0?'none':'inline-block';
}

function saveAnswer() {
  const selected = document.querySelector('input[name="answer"]:checked');
  if(selected){
    const idx = parseInt(selected.value,10);
    userAnswers[currentQuestion] = quizData[currentQuestion].options[idx];
  }
}

document.getElementById('next').addEventListener('click',()=>{
  saveAnswer();
  if(userAnswers[currentQuestion]===undefined){alert('Please select an answer!');return;}
  currentQuestion++;
  loadQuestion();
});
document.getElementById('prev').addEventListener('click',()=>{
  saveAnswer();
  if(currentQuestion>0){currentQuestion--;loadQuestion();}
});
document.getElementById('submitNow').addEventListener('click',()=>{
  saveAnswer();
  submitQuiz();
});

function submitQuiz(){
  clearInterval(timer);
  let score=0;
  for(let i=0;i<quizData.length;i++){
    const userAns=userAnswers[i];
    const correct=quizData[i].answerText;
    if(userAns!==undefined && userAns.toLowerCase()===correct.toLowerCase()) score++;
  }
  document.getElementById('quiz').innerHTML='';
  document.getElementById('prev').style.display='none';
  document.getElementById('next').style.display='none';
  document.getElementById('submitNow').style.display='none';
  document.getElementById('result').innerHTML=`
    <h2>Quiz Over!</h2>
    <p>Your score: ${score} / ${quizData.length}</p>
    <button id="review">Review Answers</button>
    <button id="restart">Restart Quiz</button>
  `;
  document.getElementById('review').addEventListener('click',()=>{showReview();});
  document.getElementById('restart').addEventListener('click',()=>{prepareQuiz(); startTimer(); loadQuestion(); document.getElementById('result').innerHTML=''; document.getElementById('prev').style.display='inline-block'; document.getElementById('next').style.display='inline-block'; document.getElementById('submitNow').style.display='inline-block';});
}

function showReview(){
  let html='<h2>Review</h2>';
  quizData.forEach((q,idx)=>{
    const userAns=userAnswers[idx];
    const correct=q.answerText;
    html+=`<div class="answer-block"><p><b>Q${idx+1}:</b> ${q.question}</p>`;
    if(userAns===undefined) html+=`<p class="unanswered">⚠ Unanswered</p>`;
    q.options.forEach(opt=>{
      const nOpt=opt.toLowerCase();
      const nUser=userAns===undefined?null:userAns.toLowerCase();
      const nCorrect=correct.toLowerCase();
      if(nOpt===nCorrect && nUser===nCorrect) html+=`<p class="correct">✔ ${opt} (Your Answer)</p>`;
      else if(nOpt===nUser && nUser!==nCorrect) html+=`<p class="wrong">✘ ${opt} (Your Answer)</p>`;
      else if(nOpt===nCorrect) html+=`<p class="correct">✔ ${opt} (Correct Answer)</p>`;
      else html+=`<p>${opt}</p>`;
    });
    html+='</div>';
  });
  html+=`<button id="restart2">Restart Quiz</button>`;
  document.getElementById('result').innerHTML=html;
  document.getElementById('restart2').addEventListener('click',()=>{prepareQuiz(); startTimer(); loadQuestion(); document.getElementById('result').innerHTML=''; document.getElementById('prev').style.display='inline-block'; document.getElementById('next').style.display='inline-block'; document.getElementById('submitNow').style.display='inline-block';});
}

/* ---------- Boot ---------- */
fetch('questions.json')
  .then(r=>r.json())
  .then(data=>{
    allQuestions=data;
    prepareQuiz();
    startTimer();
    loadQuestion();
  })
  .catch(err=>{
    document.getElementById('quiz').innerHTML='<p style="color:red">Failed to load questions.json. Check console.</p>';
    console.error(err);
  });
</script>
</body>
</html>
